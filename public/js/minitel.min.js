"use strict";function*range(e,o,t){if(void 0!==e&&e!==o)if(void 0===o&&(o=e,e=0),void 0===t&&(t=1),t=Math.abs(t),o<e)for(let r=e;r>o;r-=t)yield r;else for(let r=e;r<o;r+=t)yield r}function*range2(e,o,t){if(void 0===e)return;void 0===o&&(o=e,e=[0,0]),void 0===t&&(t=[1,1]);const[r,f]=e,[i,l]=o,[n,a]=[Math.abs(t[0])*(r<=i?1:-1),Math.abs(t[1])*(f<=l?1:-1)];if(r<=i&&f<=l)for(let e=r;e<i;e+=n)for(let o=f;o<l;o+=a)yield[e,o];else if(r<=i&&f>l)for(let e=r;e<i;e+=n)for(let o=f;o>l;o+=a)yield[e,o];else if(r>i&&f<=l)for(let e=r;e>i;e+=n)for(let o=f;o<l;o+=a)yield[e,o];else for(let e=r;e>i;e+=n)for(let o=f;o>l;o+=a)yield[e,o]}function repeat(e,o){const t=new Array(o);for(let r=0;r<o;r++)t[r]=e;return t}range().__proto__.forEach=function(e){for(let o of this)e(o)},range2().__proto__.forEach=function(e){for(let[o,t]of this)e(o,t)};
"use strict";const importHTML={import:function(e){return new Promise(((t,n)=>{const r=e.getAttribute("src"),o=new XMLHttpRequest;o.onerror=function(e){n("Error "+e.target.status+" while importing "+r)},o.onloadend=function(n){const r=document.createElement("div");r.innerHTML=n.target.responseText;for(let t of r.children)e.parentElement.insertBefore(t,e);e.parentElement.removeChild(e),t()},o.open("GET",r,!0),o.send()}))},install:function(){const e=Array.prototype.slice.call(document.getElementsByTagName("import"));return Promise.all(e.map(importHTML.import))}};
"use strict";Element.prototype.autocallback=function(t){const e={form:"submit",button:"click",div:"click"};[].slice.call(this.querySelectorAll("[data-call]")).map((a=>{const l=a.getAttribute("data-call");if(void 0===t[l])return;const r=a.tagName.toLowerCase();if(void 0===e[r])return;let c=a.getAttribute("data-param");c&&c.startsWith("{")&&(c=JSON.parse(c)),a.addEventListener(e[r],(e=>{e.preventDefault(),t[l](e,c)}))}));[].slice.call(this.querySelectorAll("[data-change]")).map((e=>{const a=e.getAttribute("data-change");if(void 0===t[a])return;let l=e.getAttribute("data-param");l&&l.startsWith("{")&&(l=JSON.parse(l));Array.prototype.slice.call(e.querySelectorAll("input, textarea, select")).map((r=>{let c="input";["radio","checkbox","select"].indexOf(r.localName)>=0&&(c="change"),r.addEventListener(c,(r=>{r.preventDefault(),t[a]({target:e},l)}))}))}))};
"use strict";function queryParameters(t){const e=window.location.search.substring(1).split("&").filter((e=>e.startsWith(t+"="))).map((e=>e.substr(t.length+1)));return 1===e.length?(r=e[0],decodeURIComponent(r.replace("+"," "))):void 0;var r}
"use strict";class FiniteStack{constructor(t){this.maxLength=t,this.stack=[]}push(t){this.stack.push(t),this.stack.length>this.maxLength&&this.stack.shift()}lastValue(){return 0==this.stack.length?null:this.stack[this.stack.length-1]}lastValues(t){return this.stack.slice(-t)}}
"use strict";class KeySimulator{constructor(t,e){this.keyPressed=new Set,this.concurrentSound=5,this.downStack=new Array(this.concurrentSound),this.upStack=void 0===e?void 0:new Array(this.concurrentSound),this.currentDownOffset=0,this.currentUpOffset=0,range(this.concurrentSound).forEach((s=>{this.downStack[s]=t.cloneNode(!0),void 0!==this.upStack&&(this.upStack[s]=e.cloneNode(!0))}))}pressKey(t){if(void 0!==this.upStack){if(this.keyPressed.has(t))return;this.keyPressed.add(t)}this.downStack[this.currentDownOffset].currentTime=0,this.downStack[this.currentDownOffset].play(),this.currentDownOffset=(this.currentDownOffset+1)%this.concurrentSound}releaseKey(t){void 0!==this.upStack&&this.keyPressed.has(t)&&(this.keyPressed.delete(t),this.upStack[this.currentDownOffset].currentTime=0,this.upStack[this.currentDownOffset].play(),this.currentUpOffset=(this.currentUpOffset+1)%this.concurrentSound)}}
"use strict";class SettingsSuite{constructor(e){this.value=void 0,this.default=void 0,this.validValues=e}setDefault(e){return this.default=this.prepareValue(e),this}add(e){if(void 0!==this.value)return this;const t=this.prepareValue(e);return void 0===t||this.validValues&&-1===this.validValues.indexOf(t)||(this.value=t),this}getValue(){return void 0===this.value?this.default:this.value}prepareValue(e){return e}}class BooleanSettingsSuite extends SettingsSuite{prepareValue(e){return!0===e||!1===e?e:"true"===e||"false"!==e&&void 0}}class IntegerSettingsSuite extends SettingsSuite{prepareValue(e){const t=parseInt(e,10);if(!isNaN(t))return t}}
"use strict";var Minitel=Minitel||{};Minitel.rows=25,Minitel.columns=40,Minitel.charWidth=8,Minitel.charHeight=10,Minitel.B300=300,Minitel.B1200=1200,Minitel.B4800=4800,Minitel.B9600=9600,Minitel.grays=["#000000","#7F7F7F","#B2B2B2","#E5E5E5","#666666","#999999","#CCCCCC","#FFFFFF"],Minitel.colors=["#000000","#FF0000","#00FF00","#FFFF00","#0000FF","#FF00FF","#00FFFF","#FFFFFF"],Minitel.contrasts=[7,7,0,0,7,7,0,0],Minitel.directStream={"clear-screen":[12],"clear-status":[31,64,65,24,10],"clear-eol":[24],"clear-end-of-screen":[27,91,74],"clear-start-of-screen":[27,91,49,74],"clear-start-of-line":[27,91,49,75],"clear-complete-line":[27,91,50,75],"clear-complete-screen":[27,91,50,74],"move-up":[11],"move-down":[10],"move-left":[8],"move-right":[9],"move-sol":[13],"content-g0":[15],"content-g1":[14],"effect-underline-on":[27,90],"effect-underline-off":[27,89],"effect-invert-on":[27,93],"effect-invert-off":[27,92],"effect-blink-on":[27,72],"effect-blink-off":[27,73],"effect-normal-size":[27,76],"effect-double-height":[27,77],"effect-double-width":[27,78],"effect-double-size":[27,79],"cursor-on":[17],"cursor-off":[20],"color-fg-0":[27,64],"color-fg-1":[27,65],"color-fg-2":[27,66],"color-fg-3":[27,67],"color-fg-4":[27,68],"color-fg-5":[27,69],"color-fg-6":[27,70],"color-fg-7":[27,71],"color-bg-0":[27,80],"color-bg-1":[27,81],"color-bg-2":[27,82],"color-bg-3":[27,83],"color-bg-4":[27,84],"color-bg-5":[27,85],"color-bg-6":[27,86],"color-bg-7":[27,87],"drcs-std-g0":[27,40,64],"drcs-drcs-g0":[27,40,32,66],"drcs-std-g1":[27,41,99],"drcs-drcs-g1":[27,41,32,67],"mask-zone-on":[27,88],"mask-zone-off":[27,95],"mask-global-on":[27,35,32,88],"mask-global-off":[27,35,32,95]},Minitel.specialChars={163:[25,35],176:[25,48],177:[25,49],8592:[25,44],8593:[25,45],8594:[25,46],8595:[25,47],188:[25,60],189:[25,61],190:[25,62],231:[25,75,99],8217:[39],224:[25,65,97],225:[25,66,97],226:[25,67,97],228:[25,72,97],232:[25,65,101],233:[25,66,101],234:[25,67,101],235:[25,72,101],236:[25,65,105],237:[25,66,105],238:[25,67,105],239:[25,72,105],242:[25,65,111],243:[25,66,111],244:[25,67,111],246:[25,72,111],249:[25,65,117],250:[25,66,117],251:[25,67,117],252:[25,72,117],338:[25,106],339:[25,122],223:[25,123],946:[25,123]},Minitel.pcToMinitelKeys={Enter:"Envoi",Tab:"Suite",ArrowDown:"Suite",ArrowUp:"Retour",Backspace:"Correction",ArrowLeft:"Annulation",ArrowRight:"Envoi",Home:"Sommaire",Escape:"Annulation",F1:"Guide",F2:"Repetition"},Minitel.keys={Videotex:{Escape:[27]," ":[32],"!":[33],'"':[34],"#":[35],$:[36],"%":[37],"&":[38],"'":[39],"(":[40],")":[41],"*":[42],"+":[43],",":[44],"-":[45],".":[46],"/":[47],0:[48],1:[49],2:[50],3:[51],4:[52],5:[53],6:[54],7:[55],8:[56],9:[57],":":[58],";":[59],"<":[60],"=":[61],">":[62],"?":[63],"@":[64],A:[65],B:[66],C:[67],D:[68],E:[69],F:[70],G:[71],H:[72],I:[73],J:[74],K:[75],L:[76],M:[77],N:[78],O:[79],P:[80],Q:[81],R:[82],S:[83],T:[84],U:[85],V:[86],W:[87],X:[88],Y:[89],Z:[90],"[":[91],"\\":[92],"]":[93],"^":[94],_:[95],"`":[96],a:[97],b:[98],c:[99],d:[100],e:[101],f:[102],g:[103],h:[104],i:[105],j:[106],k:[107],l:[108],m:[109],n:[110],o:[111],p:[112],q:[113],r:[114],s:[115],t:[116],u:[117],v:[118],w:[119],x:[120],y:[121],z:[122],"{":[123],"|":[124],"}":[125],"~":[126],DEL:[127],Envoi:[19,65],Retour:[19,66],Repetition:[19,67],Guide:[19,68],Annulation:[19,69],Sommaire:[19,70],Correction:[19,71],Suite:[19,72],Haut:[27,91,65],MajHaut:[27,91,77],Bas:[27,91,66],MajBas:[27,91,76],Droite:[27,91,66],MajDroite:[27,91,52,104],Gauche:[27,91,68],MajGauche:[27,91,80],CtrlGauche:[127],Entree:[13],MajEntree:[27,91,72],CtrlEntree:[27,91,50,74],"£":[25,35],"°":[25,48],"±":[25,49],"←":[25,44],"↑":[25,45],"→":[25,46],"↓":[25,47],"¼":[25,60],"½":[25,61],"¾":[25,62],"ç":[25,75,99],"’":[39],"à":[25,65,97],"á":[25,66,97],"â":[25,67,97],"ä":[25,72,97],"è":[25,65,101],"é":[25,66,101],"ê":[25,67,101],"ë":[25,72,101],"ì":[25,65,105],"í":[25,66,105],"î":[25,67,105],"ï":[25,72,105],"ò":[25,65,111],"ó":[25,66,111],"ô":[25,67,111],"ö":[25,72,111],"ù":[25,65,117],"ú":[25,66,117],"û":[25,67,117],"ü":[25,72,117],"Œ":[25,106],"œ":[25,122],"ß":[25,123],"β":[25,123]}},Minitel.rawChars={" ":32,"!":33,'"':34,"#":35,$:36,"%":37,"&":38,"'":39,"(":40,")":41,"*":42,"+":43,",":44,"-":45,".":46,"/":47,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,":":58,";":59,"<":60,"=":61,">":62,"?":63,"@":64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,"\\":92,"]":93,"^":94,_:95,"`":96,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122,"{":123,"|":124,"}":125,"~":126,"£":3,"°":16,"±":17,"←":12,"↑":94,"→":14,"↓":15,"¼":28,"½":29,"¾":30,"ç":21,"Ç":5,"’":39,"à":23,"À":7,"á":97,"â":4,"Â":1,"ä":97,"è":25,"È":9,"é":18,"É":2,"ê":27,"Ê":11,"ì":105,"í":105,"î":105,"ï":20,"ò":111,"ó":111,"ô":31,"ö":111,"ù":8,"ú":117,"û":22,"ü":117,"Œ":10,"œ":26,"÷":24,"⸮":0},Minitel.states={start:{1:{error:"unrecognized01"},2:{error:"unrecognized02"},3:{error:"unrecognized03"},4:{error:"unrecognized04"},5:{notImplemented:"askId"},6:{error:"unrecognized06"},7:{func:"beep"},8:{func:"moveCursor",arg:"left"},9:{func:"moveCursor",arg:"right"},10:{func:"moveCursor",arg:"down"},11:{func:"moveCursor",arg:"up"},12:{func:"clear",arg:"page"},13:{func:"moveCursor",arg:"firstColumn"},14:{func:"setCharType",arg:"G1"},15:{func:"setCharType",arg:"G0"},16:{error:"unrecognized10"},17:{func:"showCursor",arg:!0},18:{goto:"repeat"},19:{goto:"sep"},20:{func:"showCursor",arg:!1},21:{error:"unrecognized15"},22:{goto:"g2"},23:{error:"unrecognized17"},24:{func:"clear",arg:"eol"},25:{goto:"g2"},26:{func:"print",arg:127},27:{goto:"esc"},28:{error:"unrecognized1C"},29:{error:"unrecognized1D"},30:{func:"moveCursor",arg:"home"},31:{goto:"us"},"*":{func:"print",dynarg:1}},repeat:{"*":{func:"repeat",dynarg:1}},g2:{35:{func:"print",arg:3},36:{func:"print",arg:36},38:{func:"print",arg:35},44:{func:"print",arg:12},45:{func:"print",arg:94},46:{func:"print",arg:14},47:{func:"print",arg:15},48:{func:"print",arg:16},49:{func:"print",arg:17},56:{func:"print",arg:24},60:{func:"print",arg:28},61:{func:"print",arg:29},62:{func:"print",arg:30},106:{func:"print",arg:10},122:{func:"print",arg:26},65:{goto:"g2grave"},66:{goto:"g2acute"},67:{goto:"g2circ"},72:{goto:"g2trema"},75:{goto:"g2cedila"},"*":{func:"print",arg:95}},g2grave:{65:{func:"print",arg:7},97:{func:"print",arg:23},69:{func:"print",arg:9},101:{func:"print",arg:25},117:{func:"print",arg:8},"*":{func:"print",arg:95}},g2acute:{69:{func:"print",arg:2},101:{func:"print",arg:18},"*":{func:"print",arg:95}},g2circ:{65:{func:"print",arg:1},97:{func:"print",arg:4},69:{func:"print",arg:11},101:{func:"print",arg:27},117:{func:"print",arg:22},105:{func:"print",arg:13},111:{func:"print",arg:31},"*":{func:"print",arg:95}},g2trema:{69:{func:"print",arg:6},101:{func:"print",arg:19},105:{func:"print",arg:20},"*":{func:"print",arg:95}},g2cedila:{67:{func:"print",arg:5},99:{func:"print",arg:21},"*":{func:"print",arg:95}},sep:{"*":{notImplemented:"sepCommand"}},esc:{35:{goto:"mask-global"},40:{goto:"drcs-g0-use"},41:{goto:"drcs-g1-use"},55:{notImplemented:"saveContext"},56:{notImplemented:"restoreContext"},57:{goto:"pro1"},58:{goto:"pro2"},59:{goto:"pro3"},64:{func:"setFgColor",arg:0},65:{func:"setFgColor",arg:1},66:{func:"setFgColor",arg:2},67:{func:"setFgColor",arg:3},68:{func:"setFgColor",arg:4},69:{func:"setFgColor",arg:5},70:{func:"setFgColor",arg:6},71:{func:"setFgColor",arg:7},72:{func:"setBlink",arg:!0},73:{func:"setBlink",arg:!1},74:{notImplemented:"setInsertOff"},75:{notImplemented:"setInsertOn"},76:{func:"setSize",arg:"normalSize"},77:{func:"setSize",arg:"doubleHeight"},78:{func:"setSize",arg:"doubleWidth"},79:{func:"setSize",arg:"doubleSize"},80:{func:"setBgColor",arg:0},81:{func:"setBgColor",arg:1},82:{func:"setBgColor",arg:2},83:{func:"setBgColor",arg:3},84:{func:"setBgColor",arg:4},85:{func:"setBgColor",arg:5},86:{func:"setBgColor",arg:6},87:{func:"setBgColor",arg:7},88:{func:"setMask",arg:!0},89:{func:"setUnderline",arg:!1},90:{func:"setUnderline",arg:!0},91:{goto:"csi"},92:{func:"setInvert",arg:!1},93:{func:"setInvert",arg:!0},95:{func:"setMask",arg:!1}},us:{35:{goto:"drcs-define"},"*":{goto:"us-2"}},"us-2":{"*":{func:"locate",dynarg:2}},"drcs-define":{32:{goto:"drcs-define-2"},"*":{func:"drcsSetStartChar",dynarg:1,goto:"drcs-start"}},"drcs-define-2":{32:{goto:"drcs-define-3"}},"drcs-define-3":{32:{goto:"drcs-define-gselect"}},"drcs-define-gselect":{66:{goto:"drcs-define-validate-g0"},67:{goto:"drcs-define-validate-g1"}},"drcs-define-validate-g0":{73:{func:"drcsDefineCharset",arg:"G0"}},"drcs-define-validate-g1":{73:{func:"drcsDefineCharset",arg:"G1"}},"drcs-start":{48:{func:"drcsStart",goto:"drcs-read"}},"drcs-read":{48:{func:"drcsDefineChar",goto:"drcs-read"},31:{func:"drcsDefineChar",goto:"us"},"*":{func:"drcsInc",goto:"drcs-read"}},"drcs-g0-use":{64:{func:"drcsUseG0",arg:!1},32:{goto:"drcs-g0-unuse"}},"drcs-g0-unuse":{66:{func:"drcsUseG0",arg:!0}},"drcs-g1-use":{99:{func:"drcsUseG1",arg:!1},32:{goto:"drcs-g1-unuse"}},"drcs-g1-unuse":{67:{func:"drcsUseG1",arg:!0}},"mask-global":{32:{goto:"mask-global-set"}},"mask-global-set":{88:{func:"setGlobalMask",arg:!0},95:{func:"setGlobalMask",arg:!1}},csi:{74:{func:"clear",arg:"endofscreen"},49:{goto:"clearStart"},50:{goto:"clearAll"},"*":{notImplemented:"csiSequence"}},clearStart:{74:{func:"clear",arg:"startofscreen"},75:{func:"clear",arg:"startofline"}},clearAll:{74:{func:"clear",arg:"completescreen"},75:{func:"clear",arg:"completeline"}},pro1:{"*":{notImplemented:"pro1Sequence"}},pro2:{105:{goto:"startFunction"},106:{goto:"stopFunction"}},startFunction:{67:{func:"setPageMode",arg:!1},69:{func:"setUppercaseMode",arg:!1},70:{notImplemented:"startUpZoom"},71:{notImplemented:"startDownZoom"}},stopFunction:{67:{func:"setPageMode",arg:!0},69:{func:"setUppercaseMode",arg:!0},70:{notImplemented:"stopUpZoom"},71:{notImplemented:"stopDownZoom"}},pro3:{96:{goto:"pro3SwitchOff"},97:{goto:"pro3SwitchOn"},105:{goto:"pro3Start"},106:{goto:"pro3Stop"},"*":{goto:"pro3-2"}},"pro3-2":{"*":{goto:"pro3-3"}},"pro3-3":{"*":{notImplemented:"pro3Sequence"}},pro3SwitchOn:{88:{goto:"switchOnToScreen"},"*":{goto:"pro3-3"}},pro3SwitchOff:{88:{goto:"switchOffToScreen"},"*":{goto:"pro3-3"}},switchOnToScreen:{81:{func:"setSwitch",arg:[!0,"screen","keyboard"]},"*":{notImplementend:"switchOn"}},switchOffToScreen:{81:{func:"setSwitch",arg:[!1,"screen","keyboard"]},"*":{notImplementend:"switchOff"}},pro3Start:{89:{goto:"startKeyboardFunction"},"*":{goto:"pro3-3"}},pro3Stop:{89:{goto:"stopKeyboardFunction"},"*":{goto:"pro3-3"}},startKeyboardFunction:{65:{func:"setExtendedKeyboard",arg:!0},67:{func:"setCursorKeyboard",arg:!0}},stopKeyboardFunction:{65:{func:"setExtendedKeyboard",arg:!1},67:{func:"setCursorKeyboard",arg:!1}}};
"use strict";var Minitel=Minitel||{};Minitel.Protocol=class{constructor(){this.state="start",this.previousBytes=new FiniteStack(128)}moveCursor(e){}clear(e){}setPageMode(e){}beep(){}setUppercaseMode(e){}setExtendedMode(e){}setCursorKeys(e){}setCharType(e){}showCursor(e){}setFgColor(e){}setBgColor(e){}setSize(e){}setBlink(e){}setMask(e){}setGlobalMask(e){}setUnderline(e){}setInvert(e){}locate(e,t){}printDelimiter(e){}printG0Char(e){}printG1Char(e){}print(e){}repeat(e){}drcsDefineCharset(e){}drcsSetStartChar(e){}drcsStart(){}drcsInc(){}drcsDefineChar(){}drcsUseG0(e){}drcsUseG1(e){}setExtendedKeyboard(e){}setCursorKeyboard(e){}setSwitch(e,t,s){}decode(e){const t=e.charCodeAt(0);if(0===t)return;if(this.previousBytes.push(t),!(this.state in Minitel.states))return console.log("Unknown state: "+this.state),void(this.state="start");let s=null;if(t in Minitel.states[this.state]?s=Minitel.states[this.state][t]:"*"in Minitel.states[this.state]&&(s=Minitel.states[this.state]["*"]),null===s)console.log("unexpectedChar: "+t);else if("notImplemented"in s)console.log("Not implemented: "+s.notImplemented);else if("error"in s)console.log("Error: "+s.error);else if("func"in s&&!(s.func in this))console.log("Error: developer forgot to write "+s.func);else if("func"in s){let e=[];"arg"in s?e=Array.isArray(s.arg)?s.arg:[s.arg]:"dynarg"in s&&(e=this.previousBytes.lastValues(s.dynarg)),this[s.func].apply(this,e)}this.state=s&&"goto"in s?s.goto:"start"}decodeList(e){"string"==typeof e||e instanceof String?range(e.length).forEach((t=>this.decode(e[t]))):range(e.length).forEach((t=>this.decode(String.fromCharCode(e[t]))))}};
"use strict";var Minitel=Minitel||{};Minitel.Elements=class{add(t){return this[t]=void 0,this}foundIn(t){for(let i in this)this.hasOwnProperty(i)&&(this[i]=t.querySelector('[data-minitel="'+i+'"]')||void 0);return this}};
"use strict";var Minitel=Minitel||{};Minitel.TextGrid=class{constructor(i,t){this.cols=i,this.rows=t}copy(){return new Minitel.TextGrid(this.cols,this.rows)}};
"use strict";var Minitel=Minitel||{};Minitel.CharSize=class{constructor(i,t){this.width=i,this.height=t}copy(){return new Minitel.CharSize(this.width,this.height)}};
"use strict";var Minitel=Minitel||{};Minitel.FontSprite=class{constructor(t,i,h){this.grid=i,this.char=h,this.color=!0,this.spriteSheetColors={gray:[],color:[]},this.allCoordinates=[],this.spriteNumber=0,this.isReady=!1,this.spriteSheet=new Image,this.spriteSheet.onload=()=>this.generateColors(),this.spriteSheet.src=t}generateColors(){function t(t,i){const h=document.createElement("canvas");h.width=t.width,h.height=t.height;const e=h.getContext("2d"),[r,s]=[h.width,h.height];return e.clearRect(0,0,r,s),e.drawImage(t,0,0,r,s,0,0,r,s),e.fillStyle=i,e.globalCompositeOperation="source-in",e.fillRect(0,0,r,s),h}this.spriteSheetColors.color=Minitel.colors.map((i=>t(this.spriteSheet,i))),this.spriteSheetColors.gray=Minitel.grays.map((i=>t(this.spriteSheet,i))),this.generateCoordinates(),this.isReady=!0}generateCoordinates(){this.spriteNumber=this.grid.cols*this.grid.rows,range(this.spriteNumber).forEach((t=>{this.allCoordinates.push({x:Math.floor(t/this.grid.rows)*this.char.width,y:t%this.grid.rows*this.char.height})}))}toCoordinates(t){return(t<0||t>=this.grid.cols*this.grid.rows)&&(t=this.grid.cols*this.grid.rows-1),this.allCoordinates[t]}writeChar(t,i,h,e,r,s,o,a){(i<0||i>=this.spriteNumber)&&(i=this.spriteNumber-1);const c=this.allCoordinates[i],l=Math.floor(r.x*this.char.width/s.width),g=Math.floor(r.y*this.char.height/s.height);void 0===o&&(o=0);const d=this.color?this.spriteSheetColors.color[o]:this.spriteSheetColors.gray[o];t.save(),t.beginPath(),t.rect(h,e,this.char.width,this.char.height),t.clip(),2===s.height?0===r.y?(t.drawImage(d,c.x+l,c.y+g,this.char.width/s.width,1/s.height,h,e,this.char.width,1),t.drawImage(d,c.x+l,c.y+g,this.char.width/s.width,this.char.height/s.height,h,e+1,this.char.width,this.char.height)):(t.drawImage(d,c.x+l,c.y+g-1,this.char.width/s.width,1/s.height,h,e,this.char.width,1),t.drawImage(d,c.x+l,c.y+g,this.char.width/s.width,this.char.height/s.height,h,e+1,this.char.width,this.char.height)):t.drawImage(d,c.x+l,c.y+g,this.char.width/s.width,this.char.height/s.height,h,e,this.char.width,this.char.height),a&&r.y===s.height-1&&(t.fillStyle=this.color?Minitel.colors[o]:Minitel.grays[o],t.fillRect(h,e+this.char.height-1,this.char.width,1)),t.restore()}defineChar(t,i){if(t<=32||t>=127)return;if(10!==i.length)return;const h=this.toCoordinates(t),e=(t,e)=>{const r=t.getContext("2d");r.globalCompositeOperation="source-over",r.clearRect(h.x,h.y,this.char.width,this.char.height),r.fillStyle=e,i.forEach(((t,i)=>{t&=255,range(8).forEach((e=>{t&1<<7-e&&r.fillRect(h.x+e,h.y+i,1,1)}))}))};this.spriteSheetColors.color.forEach(((t,i)=>{e(t,Minitel.colors[i])})),this.spriteSheetColors.gray.forEach(((t,i)=>{e(t,Minitel.grays[i])}))}};
"use strict";var Minitel=Minitel||{};Minitel.Cell=class{constructor(t,i){this.value=t,this.fgColor=i}copy(){return new Minitel.Cell(this.value,this.fgColor)}toString(){return""}fromString(){this.value=32}},Minitel.CharCell=class extends Minitel.Cell{constructor(){super(32,7),this.blink=!1,this.invert=!1,this.mult={width:1,height:1},this.part={x:0,y:0},this.drcs=!1,Object.preventExtensions(this)}isAlphanumerical(){return this.value>=65&&this.value<=90||this.value>=97&&this.value<=122||this.value>=48&&this.value<=57}hasSameAttributes(t){return t.fgColor===this.fgColor&&t.blink===this.blink&&t.invert===this.invert&&t.mult.width===this.mult.width&&t.mult.height===this.mult.height&&t.part.x===this.part.x&&t.part.y===this.part.y&&t.drcs===this.drcs}upperPart(){return Minitel.Cell.upperPart(this.mult,this.part)}rootPart(){return Minitel.Cell.rootPart(this.mult,this.part)}copy(){const t=new Minitel.CharCell;return t.value=this.value,t.fgColor=this.fgColor,t.blink=this.blink,t.invert=this.invert,t.mult={width:this.mult.width,height:this.mult.height},t.part={x:this.part.x,y:this.part.y},t.drcs=this.drcs,t}toString(){return"C"+this.value.toString(16).padStart(2,"0")+this.fgColor.toString()+(this.blink?"1":"0")+(this.invert?"1":"0")+this.mult.width.toString()+this.mult.height.toString()+this.part.x.toString()+this.part.y.toString()+(this.drcs?"1":"0")}fromString(t){return"C"===t.substr(0,1)&&(11===t.length&&(this.value=parseInt(t.substr(1,2),16),this.fgColor=parseInt(t.substr(3,1)),this.blink="1"===t.substr(4,1),this.invert="1"===t.substr(5,1),this.mult.width=parseInt(t.substr(6,1)),this.mult.height=parseInt(t.substr(7,1)),this.part.x=parseInt(t.substr(8,1)),this.part.y=parseInt(t.substr(9,1)),void(this.drcs="1"===t.substr(10,1))))}},Minitel.MosaicCell=class extends Minitel.Cell{constructor(){super(64,7),this.bgColor=0,this.blink=!1,this.separated=!1,this.drcs=!1,Object.preventExtensions(this)}copy(){const t=new Minitel.MosaicCell;return t.value=this.value,t.fgColor=this.fgColor,t.bgColor=this.bgColor,t.blink=this.blink,t.separated=this.separated,t.drcs=this.drcs,t}toString(){return"M"+this.value.toString(16).padStart(2,"0")+this.fgColor.toString()+this.bgColor.toString()+(this.blink?"1":"0")+(this.separated?"1":"0")+(this.drcs?"1":"0")}fromString(t){return"M"===t.substr(0,1)&&(8===t.length&&(this.value=parseInt(t.substr(1,2),16),this.fgColor=parseInt(t.substr(3,1)),this.bgColor=parseInt(t.substr(4,1)),this.blink="1"===t.substr(5,1),this.separated="1"===t.substr(6,1),void(this.drcs="1"===t.substr(7,1))))}},Minitel.DelimiterCell=class extends Minitel.Cell{constructor(){super(32,7),this.bgColor=0,this.invert=!1,this.zoneUnderline=void 0,this.mask=void 0,this.mult={width:1,height:1},Object.preventExtensions(this)}upperPart(){return Minitel.Cell.upperPart(this.mult,this.part)}rootPart(){return Minitel.Cell.rootPart(this.mult,this.part)}copy(){const t=new Minitel.DelimiterCell;return t.value=this.value,t.fgColor=this.fgColor,t.bgColor=this.bgColor,t.invert=this.invert,t.zoneUnderline=this.zoneUnderline,t.mask=this.mask,t.mult={width:this.mult.width,height:this.mult.height},t}toString(){return"D"+this.value.toString(16).padStart(2,"0")+this.fgColor.toString()+this.bgColor.toString()+(this.invert?"1":"0")+(this.zoneUnderline?"1":"0")+(this.mask?"1":"0")+this.mult.width.toString()+this.mult.height.toString()}fromString(t){return"D"===t.substr(0,1)&&(10===t.length&&(this.value=parseInt(t.substr(1,2),16),this.fgColor=parseInt(t.substr(3,1)),this.bgColor=parseInt(t.substr(4,1)),this.invert="1"===t.substr(5,1),this.zoneUnderline="1"===t.substr(6,1),this.mask="1"===t.substr(7,1),this.mult.width=parseInt(t.substr(8,1)),void(this.mult.height=parseInt(t.substr(9,1)))))}},Minitel.Cell.fromString=function(t){let i;return i="C"===t.substr(0,1)?new Minitel.CharCell:"M"===t.substr(0,1)?new Minitel.MosaicCell:new Minitel.DelimiterCell,i.fromString(t),i},Minitel.Cell.upperPart=function(t,i){return t.height>1&&0===i.y},Minitel.Cell.rootPart=function(t,i){return 0===i.x&&(t.height>1&&1===i.y||1===t.height&&0===i.y)};
"use strict";var Minitel=Minitel||{};Minitel.VRAM=class{constructor(r){this.grid=r,this.memory=[],range(0,this.grid.rows).forEach((r=>{let i=[];range(0,this.grid.cols).forEach((r=>{i[r]=new Minitel.MosaicCell})),this.memory[r]=i}))}set(r,i,t){this.memory[i][r]=t}get(r,i){return void 0===i?this.memory[r]:this.memory[i][r]}clear(){range(1,this.grid.rows).forEach((r=>{range(0,this.grid.cols).forEach((i=>{this.memory[r][i]=new Minitel.MosaicCell}))}))}scroll(r){const i=new Array(this.grid.cols);range(0,this.grid.cols).forEach((r=>{i[r]=new Minitel.MosaicCell})),"up"===r?(range(1,this.grid.rows).forEach((r=>{this.memory[r]=this.memory[r+1]})),this.memory[this.grid.rows-1]=i):"down"===r&&(range(this.grid.rows-1,1).forEach((r=>{this.memory[r]=this.memory[r-1]})),this.memory[1]=i)}getWordAt(r,i){if(r<0||r>=this.grid.cols)return"";if(i<0||i>=this.grid.rows)return"";const t=this.memory[i][r];if(!(t instanceof Minitel.CharCell))return"";if(!t.isAlphanumerical())return"";let e=r-1;for(;e>=0&&this.memory[i][e]instanceof Minitel.CharCell&&this.memory[i][e].hasSameAttributes(t)&&this.memory[i][e].isAlphanumerical();)e--;let s=r+1;for(;s<this.grid.cols&&this.memory[i][s]instanceof Minitel.CharCell&&this.memory[i][s].hasSameAttributes(t)&&this.memory[i][s].isAlphanumerical();)s++;let o="";return this.memory[i].slice(e+1,s).forEach((r=>{o+=String.fromCharCode(r.value)})),o}load(r,i,t,e,s){if(null==r)return;const o={C:11,M:8,D:10};let h=0;i=i||0,t=t||1,e=e||this.grid.cols,s=s||this.grid.rows-t,range(t,t+s).forEach((t=>{range(i,i+e).forEach((i=>{const e=r.substr(h,1);if(!(e in o))throw new SyntaxError("Unknown cell type "+e+" @"+h);i<this.grid.cols&&t<this.grid.rows&&this.set(i,t,Minitel.Cell.fromString(r.substr(h,o[e]))),h+=o[e]}))}))}save(r,i,t,e){let s="";return r=r||0,i=i||1,t=t||this.grid.cols,e=e||this.grid.rows-i,range(i,i+e).forEach((i=>{range(r,r+t).forEach((r=>{s+=this.memory[i][r].toString()}))})),s}};
"use strict";var Minitel=Minitel||{};Minitel.VDUCursor=class{constructor(i,t,s){this.grid=i,this.char=t,this.x=0,this.y=0,this.visible=!1,this.color="#FFFFFF",this.canvas=s,this.previousState="",this.indicator=!1,this.indicatorWidth=1,this.indicatorHeight=1,this.refresh=void 0,void 0!==this.canvas&&(this.refresh=window.setInterval((()=>this.draw()),20))}setIndicator(i){return this.indicator=i,this}setDimension(i,t){return void 0===i||i<1?i=1:this.x+i>=this.grid.cols&&(i=this.grid.cols-this.x),void 0===t||t<1?t=1:this.y+t>=this.grid.rows&&(t=this.grid.rows-this.y),this.indicatorWidth=i,this.indicatorHeight=t,this}set(i,t){return this.x=i,this.y=t,this.setDimension(this.indicatorWidth,this.indicatorHeight),this}left(i){this.set(this.x-(i||1),this.y)}right(i){this.set(this.x+(i||1),this.y)}up(i){this.set(this.x,this.y-(i||1))}down(i){this.set(this.x,this.y+(i||1))}setColor(i){return this.color=i,this}setVisible(i){this.visible=i}getBlink(){return(new Date).getTime()%900>=450}home(){this.set(0,1)}lastColumn(){this.set(this.grid.cols-1,this.y)}firstColumn(){this.set(0,this.y)}lastRow(){this.set(this.x,this.grid.rows-1)}statusRow(){this.set(this.x,0)}firstRow(){this.set(this.x,1)}isOnStatusRow(){return 0===this.y}isOnFirstRow(){return 1===this.y}isOnLastRow(){return this.y===this.grid.rows-1}isOnFirstCol(){return 0===this.x}isOnLastCol(){return this.x===this.grid.cols-1}homeToCursor(i){range(0,this.x+1).forEach((t=>i(t,this.y)));const[t,s]=[this.grid.cols,this.y];range2([0,0],[s,t]).forEach(((t,s)=>i(s,t)))}cursorToEndOfScreen(i){range(this.x,this.grid.cols).forEach((t=>i(t,this.y)));const[t,s]=[this.grid.cols,this.grid.rows];range2([this.y+1,0],[s,t]).forEach(((t,s)=>i(s,t)))}cursorToEndOfLine(i){range(this.x,this.grid.cols).forEach((t=>i(t,this.y)))}allStatusRow(i){range(this.grid.cols).forEach((t=>i(t,0)))}firstColumnToCursor(i){range(0,this.x+1).forEach((t=>i(t,this.y)))}allCurrentRow(i){range(0,this.grid.cols).forEach((t=>i(t,this.y)))}overflowY(){return this.y<0||this.y>=this.grid.rows}overflowX(){return this.x<0||this.x>=this.grid.cols}currentState(){return String(this.x)+"-"+String(this.y)+"-"+String(this.color)+"-"+String(this.visible)+"-"+String(this.indicator)+"-"+String(this.indicatorWidth)+"-"+String(this.indicatorHeight)+"-"+String(this.getBlink())}draw(){const i=this.currentState();if(i===this.previousState)return;this.previousState=i;const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),this.isOnStatusRow()||!this.visible||this.getBlink()||(t.fillStyle=this.color,t.fillRect(this.x*this.char.width,this.y*this.char.height,this.char.width,this.char.height)),this.indicator&&(t.beginPath(),t.strokeStyle="#FFFF00",t.setLineDash([2,1]),t.moveTo(0,this.y*this.char.height),t.lineTo(1e3,this.y*this.char.height),t.moveTo(0,(this.y+this.indicatorHeight)*this.char.height),t.lineTo(1e3,(this.y+this.indicatorHeight)*this.char.height),t.moveTo(this.x*this.char.width,0),t.lineTo(this.x*this.char.width,1e3),t.moveTo((this.x+this.indicatorWidth)*this.char.width,0),t.lineTo((this.x+this.indicatorWidth)*this.char.width,1e3),t.stroke())}saveState(){return{x:this.x,y:this.y,color:this.color,visible:this.visible}}restoreState(i){this.x=i.x,this.y=i.y,this.color=i.color,this.visible=i.visible}};
"use strict";var Minitel=Minitel||{};Minitel.VDU=class{constructor(t,i,A,s,e){this.grid=t,this.char=i,this.canvas=A,this.context=this.createContext(),this.statusCharacter=70,this.globalMask=!0;const r=[];range(this.grid.rows).forEach((()=>r.push(!1))),this.cursor=new Minitel.VDUCursor(t,i,e),this.vram=new Minitel.VRAM(t),this.lastblink=this.getBlink(),this.blinking=r.map((()=>!1)),this.changed=r.map((()=>!0));let h="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAACgCAYAAAC8LWpcAAAAV0lEQVR42u3SsREAMAgDMcj+OzsbUKYIUuuKP6oAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeKd/PzBJpv1s/wABBBBAAAEEEGCvC4CRBBCAav6pAAAAAElFTkSuQmCC";this.font={G0:this.loadFont("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAACgAQMAAACG4/gfAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAA7AAAAOwASfED60AAAAHdElNRQfhBQ0LFxgx/MYLAAACvElEQVQ4y31UoY7kSAx9OypQ4IBBg4DRyaBBwYAAg2hUwKBBQLQKGLA6LWiw4MDAgJKuP20/YD9iP+Skvud0emZ0o11rNP3ksp9d9qsAd7MOYiuBH1HcCWoH/+JYoXQu69UhBF8q4hClBqBHrGK9s9QPgAE0s0gR6TdmNBH3YYRJgMnhBG3hYWO8n8ITMQNjdksfAJBzsXWtUYItO8FoJbmvz1BHt65+Rt+IZ55pRfUTwWhoq6/vOvxouZS29XxAEMYtrOVa6TMvXTXeXlpLNVXDsW7VU1Q32vo7ZimS15YUhSN3IRj6ubiwq0ns5OLKaRzaBiZZ8gYGs7zK2AXBr5gNX1uLVh3nWrcNMqm6OWqV9MIeCTRVZ5TXySv/wewP41UHznDnUf0/cxHtmkfxMmulQDBiZgkOWV3Xl/Li6H3xWrRAJw5ZCMZhMAL53TRUpVm02onc5oxBc/XRYROkhiT4p9PiC9rEcsu4wAfoWFLZSY53tu49M7JtkuhCYr5tW93Lc0hLrcm5wDePS8iPMc6VbFm3Rn65QVUzJiEzSyJ0NG6p9EGXx5A0VZcTARvm5AkGxjBL7FW9/ra2Vxu53MeWgRkLcoTOTMu5a3j+LKyXM+a/2KNmwTwvONWsGJ9EWa/tJKc7W//Ke2EqKz7qBYciOAnBaKKzHC/sueGrlAt7Jqn0l+hZT+GhJtUfGbM/6Msb4f4jcZBq7QXyHXwgVBEfmlQl+MeDKjyxSk4LcuByUyjtSVNLRpBI/HAX9ac3dRPyxI2gfAf+zgSs1Zb87RP6iUd5Ycznsd1A2j2WI4sAf+48r4S7XYGf/BTItkpeMBaQ2fN5eQb+PSIvcqbnB2SK7cqBMduan6j9DaT3z3DjubFf+Yge4rNBUB5CRQRIiWImsJypPYJQW4AlnnoAMxXbYm7fzettxFdc/wN/jK6fiKp77QAAAABJRU5ErkJggg=="),G1:this.loadFont("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAACgAQMAAACG4/gfAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAA8IAAAPCAXwnuBMAAAAHdElNRQfhBx0HKg6MA8Z/AAAAdUlEQVQ4y6WTMQoAIQwE01n6VTu/7Q+85ODMgbKFM9WCZCSLmkFa6Tbq/IUgQnOGk+E9+QIwF6c6GYIVgLk708kQrADMamgr6tDYVc/QLHqGZtEzNAv2dQ7v56pnaBZT0Cx6hmbBfunhN131DM1iU2gWU8z8AAKipvAkox1OAAAAAElFTkSuQmCC"),G0d:this.loadFont(h),G1d:this.loadFont(h)},this.changeColors(s),this.refresh=window.setInterval((()=>{this.render();const t=this.vram.get(this.cursor.x,this.cursor.y);this.cursor.setColor(this.colors[t.fgColor])}),20)}redraw(t){void 0===t?this.changed=this.changed.map((()=>!0)):this.changed[t]=!0}setStatusCharacter(t){this.statusCharacter=t}set(t,i,A){this.vram.set(t,i,A),this.changed[i]=!0}get(t,i){return this.vram.get(t,i)}clear(){this.vram.clear(),this.redraw()}scroll(t){this.vram.scroll(t),this.redraw()}getBlink(){return(new Date).getTime()%1500>=750}createContext(){const t=this.canvas.getContext("2d");return t.imageSmoothingEnabled=!1,t.fillStyle="#000000",t.fillRect(0,0,this.char.width*this.grid.cols,this.char.height*this.grid.rows),t}loadFont(t){return new Minitel.FontSprite(t,{cols:8,rows:16},this.char)}defineCharG0(t,i){this.font.G0d.defineChar(t,i),this.redraw()}defineCharG1(t,i){this.font.G1d.defineChar(t,i),this.redraw()}setGlobalMask(t){this.globalMask=t,this.redraw()}changeColors(t){this.colors=t?Minitel.colors:Minitel.grays;for(let i in this.font)this.font.hasOwnProperty(i)&&(this.font[i].color=t);this.redraw()}generateThumbnail(t,i){const A=document.createElement("canvas");A.width=t,A.height=i;const s=A.getContext("2d");return s.imageSmoothingEnabled=!1,s.drawImage(this.canvas,0,0,t,i),A.toDataURL("image/png")}render(){if(!(this.font.G0.isReady&&this.font.G1.isReady&&this.font.G0d.isReady&&this.font.G1d.isReady))return;const t=new Minitel.CharCell;t.value=this.statusCharacter,t.invert=!0,this.vram.set(38,0,t);const i=this.getBlink();range(0,this.grid.rows).forEach((t=>{if(!(this.changed[t]||this.blinking[t]&&this.lastBlink!==i))return;this.changed[t]=!1;let A=this.drawRow(this.vram.get(t),t,i);this.blinking[t]=A})),this.lastBlink=i}drawRow(t,i,A){let s=0,e=!1,r=!1;const h=i*this.char.height;let n=!1;return range(0,this.grid.cols).forEach((i=>{const a=t[i],o=i*this.char.width;a instanceof Minitel.CharCell||(s=a.bgColor,r=!1),a instanceof Minitel.DelimiterCell||!0!==a.blink||(n=!0);let l=7,c=0;a instanceof Minitel.MosaicCell||!0!==a.invert?[l,c]=[a.fgColor,s]:[l,c]=[s,a.fgColor],this.drawCharacter(o,h,a,l,c,e,A,r),a instanceof Minitel.DelimiterCell&&(void 0!==a.mask&&(e=this.globalMask&&a.mask),void 0!==a.zoneUnderline&&(r=a.zoneUnderline))})),n}drawCharacter(t,i,A,s,e,r,h,n){const a=this.context;if(a.fillStyle=this.colors[e],a.fillRect(t,i,this.char.width,this.char.height),r)return;if(!(A instanceof Minitel.DelimiterCell)&&A.blink&&h===(A instanceof Minitel.MosaicCell||!A.invert))return;let o,l={x:0,y:0},c={width:1,height:1},g=!1;A instanceof Minitel.CharCell?(o=A.drcs?this.font.G0d:this.font.G0,l=A.part,c=A.mult,g=n):A instanceof Minitel.DelimiterCell?(o=A.drcs?this.font.G0d:this.font.G0,c=A.mult,g=n):o=A.drcs?this.font.G1d:this.font.G1,o.writeChar(a,A.value,t,i,l,c,s,g)}getWordAt(t,i){const A=Math.floor(t*this.grid.cols/this.canvas.offsetWidth),s=Math.floor(i*this.grid.rows/this.canvas.offsetHeight);return this.vram.getWordAt(A,s)}};
"use strict";var Minitel=Minitel||{};Minitel.Decoder=class extends Minitel.Protocol{constructor(t,r=null,s=null,i=null){if(super(),this.pageMode=!0,this.vdu=t,this.clear("page"),this.clear("status"),this.resetCurrent(),this.charCode=32,this.drcs={g0:!1,g1:!1,charsetToDefine:void 0,startChar:void 0,count:0},this.sender=s,s&&this.vdu.setStatusCharacter(67),this.keyboardToScreen=!s,this.keyboard=r,r){const t=this;r.setEmitter((function(r){t.keyboardToScreen&&t.decodeList(r),null!==t.sender&&t.sender(r.reduce(((t,r)=>t+String.fromCharCode(r)),""))}))}this.bip=i}saveState(){this.savedState={current:Object.assign({},this.current),waiting:Object.assign({},this.waiting),cursor:this.vdu.cursor.saveState()}}restoreState(){this.current=Object.assign({},this.savedState.current),this.waiting=Object.assign({},this.savedState.waiting),this.vdu.cursor.restoreState(this.savedState.cursor)}resetCurrent(){this.current={charType:Minitel.CharCell,mult:{width:1,height:1},fgColor:7,bgColor:0,underline:!1,blink:!1,invert:!1,mask:!1,separated:!1},this.waiting={bgColor:void 0,mask:void 0,underline:void 0}}serialAttributesDefined(){return void 0!==this.waiting.bgColor||void 0!==this.waiting.underline||void 0!==this.waiting.mask}moveCursor(t){if("char"===t)this.vdu.cursor.right(this.current.mult.width),this.vdu.cursor.overflowX()&&(this.vdu.cursor.isOnStatusRow()?this.vdu.cursor.lastColumn():(this.vdu.cursor.firstColumn(),range(this.current.mult.height).forEach((()=>this.moveCursor("down")))));else if("left"===t)this.vdu.cursor.left(),this.vdu.cursor.overflowX()&&(this.vdu.cursor.lastColumn(),this.moveCursor("up"));else if("right"===t)this.vdu.cursor.right(),this.vdu.cursor.overflowX()&&(this.vdu.cursor.firstColumn(),this.moveCursor("down"));else if("up"===t){if(this.vdu.cursor.isOnStatusRow())return;this.vdu.cursor.up(),this.vdu.cursor.isOnStatusRow()&&(this.pageMode?this.vdu.cursor.lastRow():(this.vdu.cursor.firstRow(),this.vdu.scroll("down")))}else"down"===t?this.vdu.cursor.isOnStatusRow()?this.restoreState():(this.vdu.cursor.down(),this.vdu.cursor.overflowY()&&(this.pageMode?this.vdu.cursor.firstRow():(this.vdu.cursor.lastRow(),this.vdu.scroll("up")))):"firstColumn"===t?this.vdu.cursor.firstColumn():"home"===t&&(this.vdu.cursor.home(),this.resetCurrent())}clear(t){if("page"===t)return this.vdu.clear(),this.vdu.cursor.home(),void this.resetCurrent();if("status"!==t){if("eol"===t){const t=this.vdu.cursor.x,r=this.vdu.cursor.y,s=this.pageMode;return this.pageMode=!0,this.vdu.cursor.cursorToEndOfLine((()=>this.print(32))),this.vdu.cursor.x=t,this.vdu.cursor.y=r,void(this.pageMode=s)}this.vdu.cursor.isOnStatusRow()||("endofscreen"!==t?"startofscreen"!==t?"startofline"!==t?"completescreen"!==t?"completeline"!==t||this.vdu.cursor.allCurrentRow(((t,r)=>{this.vdu.set(t,r,new Minitel.MosaicCell)})):this.vdu.clear():this.vdu.cursor.firstColumnToCursor(((t,r)=>{this.vdu.set(t,r,new Minitel.MosaicCell)})):this.vdu.cursor.homeToCursor(((t,r)=>{this.vdu.set(t,r,new Minitel.MosaicCell)})):this.vdu.cursorToEndOfScreen(((t,r)=>{this.vdu.set(t,r,new Minitel.MosaicCell)})))}else this.vdu.cursor.allStatusRow(((t,r)=>{this.vdu.set(t,r,new Minitel.MosaicCell)}))}setPageMode(t){this.pageMode=t}beep(){null!==this.bip&&(this.bip.currentTime=0,this.bip.play())}setUppercaseMode(t){this.keyboard.setUppercaseMode(t)}setExtendedMode(t){this.keyboard.setExtendedMode(t)}setCursorKeys(t){this.keyboard.setCursorKeys(t)}setCharType(t){this.current.separated=!1,this.current.invert=!1,this.current.mult={width:1,height:1},"G0"===t?this.current.charType=Minitel.CharCell:"G1"===t&&(this.current.charType=Minitel.MosaicCell,this.current.underline=!1,void 0!==this.waiting.bgColor&&(this.current.bgColor=this.waiting.bgColor,this.waiting.bgColor=void 0))}showCursor(t){this.vdu.cursor.setVisible(t)}setFgColor(t){this.current.fgColor=t}setBgColor(t){this.current.charType===Minitel.CharCell?this.waiting.bgColor=t:this.current.charType===Minitel.MosaicCell&&(this.current.bgColor=t)}setSize(t){if(this.vdu.cursor.isOnStatusRow())return;if(this.current.charType!==Minitel.CharCell)return;const r={normalSize:{width:1,height:1},doubleWidth:{width:2,height:1},doubleHeight:{width:1,height:2},doubleSize:{width:2,height:2}};t in r&&(this.vdu.cursor.isOnFirstRow()&&2===r[t].height||(this.current.mult=r[t]))}setBlink(t){this.current.blink=t}setMask(t){this.waiting.mask=t}setGlobalMask(t){this.vdu.setGlobalMask(t)}setUnderline(t){this.current.charType===Minitel.CharCell?this.waiting.underline=t:this.current.charType===Minitel.MosaicCell&&(this.current.separated=t)}setInvert(t){this.current.charType!==Minitel.MosaicCell&&(this.current.invert=t)}locate(t,r){48===t||49===t||50===t?(t=10*(t-48)+(r-48),r=1):(r-=64,t-=64),r<1||r>40||t<0||t>24||(0===t&&(this.saveState(),this.showCursor(!1)),this.vdu.cursor.set(r-1,t),this.resetCurrent())}printDelimiter(t){const r=this.vdu.cursor.x,s=this.vdu.cursor.y,i=new Minitel.DelimiterCell;i.value=t,i.fgColor=this.current.fgColor,i.invert=this.current.invert,i.mult=this.current.mult,void 0===this.waiting.bgColor?i.bgColor=this.current.bgColor:(i.bgColor=this.waiting.bgColor,this.waiting.bgColor=void 0),this.current.bgColor=i.bgColor,i.zoneUnderline=this.current.underline,void 0!==this.waiting.underline&&(i.zoneUnderline=this.waiting.underline,this.current.underline=this.waiting.underline,this.waiting.underline=void 0),i.mask=this.current.mask,void 0!==this.waiting.mask&&(i.mask=this.waiting.mask,this.current.mask=this.waiting.mask,this.waiting.mask=void 0),range2([i.mult.height,i.mult.width]).forEach(((t,e)=>{const o=i.copy();this.vdu.set(r+e,s-t,o)}))}printG0Char(t){const r=this.vdu.cursor.x,s=this.vdu.cursor.y,i=new Minitel.CharCell;i.value=t,i.fgColor=this.current.fgColor,i.blink=this.current.blink,i.invert=this.current.invert,i.mult=this.current.mult,i.drcs=0!==s&&this.drcs.g0,range2([i.mult.height,i.mult.width]).forEach(((t,e)=>{const o=i.copy();o.part={x:e,y:i.mult.height-t-1},this.vdu.set(r+e,s-t,o)}))}printG1Char(t){const r=new Minitel.MosaicCell;r.value=t,r.fgColor=this.current.fgColor,r.bgColor=this.current.bgColor,r.blink=this.current.blink,r.separated=this.current.separated,r.drcs=!this.vdu.cursor.isOnStatusRow()&&this.drcs.g1,r.value>=32&&r.value<=95&&!r.drcs&&(r.value+=32),!0===r.separated&&(r.value-=64),this.vdu.set(this.vdu.cursor.x,this.vdu.cursor.y,r)}print(t){this.current.charType===Minitel.MosaicCell?this.printG1Char(t):32===t&&this.serialAttributesDefined()?this.printDelimiter(t):this.current.charType===Minitel.CharCell&&this.printG0Char(t),this.charCode=t,this.moveCursor("char")}repeat(t){range(t-=64).forEach((()=>this.print(this.charCode)))}drcsDefineCharset(t){this.drcs.charsetToDefine=t}drcsSetStartChar(t){this.drcs.startChar=t}drcsStart(){this.drcs.count=0}drcsInc(){this.drcs.count++}drcsDefineChar(){const t=this.previousBytes.lastValues(this.drcs.count+1).slice(0,-1).map((t=>t-64&63)),r=[t[0]<<2|t[1]>>4,(15&t[1])<<4|t[2]>>2,(3&t[2])<<6|t[3],t[4]<<2|t[5]>>4,(15&t[5])<<4|t[6]>>2,(3&t[6])<<6|t[7],t[8]<<2|t[9]>>4,(15&t[9])<<4|t[10]>>2,(3&t[10])<<6|t[11],t[12]<<2|t[13]>>4];"G0"===this.drcs.charsetToDefine?this.vdu.defineCharG0(this.drcs.startChar,r):this.vdu.defineCharG1(this.drcs.startChar,r),this.drcs.startChar++,this.drcs.count=0}drcsUseG0(t){this.drcs.g0=t}drcsUseG1(t){this.drcs.g1=t}setExtendedKeyboard(t){null!==this.keyboard&&this.keyboard.setExtendedMode(t)}setCursorKeyboard(t){null!==this.keyboard&&this.keyboard.setCursorKeyboard(t)}setSwitch(t,r,s){"screen"===r&&"keyboard"===s&&(this.keyboardToScreen=t)}};
"use strict";var Minitel=Minitel||{};Minitel.Keyboard=class{constructor(e,t,i){this.kCtrl=!1,this.kShift=!1,this.kFnct=!1,this.kExtended=!1,this.kCursorKeys=!1,this.kUppercase=!0,this.emitter=void 0,this.setEmitter(t),this.config=void 0,this.setConfig(i);const s=new Minitel.Elements;s.add("keyalpha").add("keynonalpha").add("keyconfig").add("keysound").foundIn(e),this.pageAlpha=s.keyalpha,this.pageNAlpha=s.keynonalpha,this.pageConfig=s.keyconfig,this.simulator=s.keysound?new KeySimulator(s.keysound):void 0,document.addEventListener("keyup",(e=>this.onkeyup(e))),document.addEventListener("keypress",(e=>this.onkeypress(e))),e.autocallback(this)}setEmitter(e){this.emitter=e}keypress(e){this.emitter&&null!==e&&this.emitter(e)}setConfig(e){this.config=e}selectSpeed(e){this.pageConfig.querySelector(".config-speed>select").value=e}selectColor(e){this.pageConfig.querySelector(".config-color>select").value=e}onSettingChanged(e){if(void 0===this.config)return;const t=e.target.querySelector(".config-speed>select").value,i=e.target.querySelector(".config-color>select").value;this.config({speed:"FULL"===t?0:parseInt(t),color:"true"===i})}onAlpha(){this.pageNAlpha.classList.add("hidden"),this.pageConfig.classList.add("hidden"),this.pageAlpha.classList.remove("hidden")}onNAlpha(){this.pageAlpha.classList.add("hidden"),this.pageConfig.classList.add("hidden"),this.pageNAlpha.classList.remove("hidden")}onConfig(){this.pageAlpha.classList.add("hidden"),this.pageNAlpha.classList.add("hidden"),this.pageConfig.classList.remove("hidden")}onkeyup(e){e.preventDefault()}onkeypress(e){this.kShift=e.shiftKey,this.keypress(this.toMinitel(e.key)),e.preventDefault()}onclick(e,t){this.simulator&&this.simulator.pressKey(t),"Maj"===t&&(this.kShift=!this.kShift),this.keypress(this.toMinitel(t))}setUppercaseMode(e){this.kUppercase=e}setExtendedMode(e){this.kExtended=e}setCursorKeys(e){this.kCursorKeys=e}toMinitel(e){return 1===e.length?e=this.kUppercase!==this.kShift?e.toUpperCase():e.toLowerCase():e in Minitel.pcToMinitelKeys&&(e=Minitel.pcToMinitelKeys[e]),e in Minitel.keys.Videotex?Minitel.keys.Videotex[e]:null}};
"use strict";var Minitel=Minitel||{};Minitel.Emulator=class{constructor(e,t,i){const s=new Minitel.TextGrid(Minitel.columns,Minitel.rows),r=new Minitel.CharSize(Minitel.charWidth,Minitel.charHeight),o=new Minitel.Elements;if(o.add("screen").add("cursor").add("keyboard").add("beep").foundIn(e),void 0===o.screen)return void console.error("The emulator container has no canvas for screen.");o.screen.width=r.width*s.cols,o.screen.height=r.height*s.rows,void 0!==o.cursor&&(o.cursor.width=o.screen.width,o.cursor.height=o.screen.height),this.pause=!1,this.recordHandler=void 0,this.emptyHandler=void 0,this.color=t,this.vdu=new Minitel.VDU(s,r,o.screen,this.color?Minitel.colors:Minitel.greys,o.cursor),this.keyboard=o.keyboard?new Minitel.Keyboard(o.keyboard):void 0;const n=e.getAttribute("data-socket")||void 0;this.socket=n?new WebSocket(n):void 0,this.socket&&(this.socket.onopen=()=>{this.socket.onmessage=e=>{const t=[];range(e.data.length).forEach((i=>{t.push(e.data[i].charCodeAt(0))})),this.send(t)},this.keyboard&&this.keyboard.setEmitter((e=>this.socket.send(e.map((e=>String.fromCharCode(e))).join(""))))},this.socket.onclose=()=>{this.vdu.setStatusCharacter(70),this.keyboard&&this.keyboard.setEmitter(void 0)});this.decoder=new Minitel.Decoder(this.vdu,this.keyboard,(e=>{this.socket&&this.socket.send(e)}),o.beep),this.queue=[],this.chunkSize=0,this.timer=void 0,this.cursorShown=!1,this.bandwidth=-1;const h=new BooleanSettingsSuite([!0,!1]);this.setColor(h.setDefault(!1).add(queryParameters("color")).add(t).add(e.getAttribute("data-color")).getValue());const d=new IntegerSettingsSuite([1200,4800,9600,0]);this.setRefresh(d.setDefault(Minitel.B1200).add(queryParameters("speed")).add(i).add(e.getAttribute("data-speed")).getValue()),o.screen.addEventListener("click",(e=>this.onClick(e))),this.keyboard&&this.keyboard.setConfig((e=>{this.setColor(e.color),this.setRefresh(e.speed)}))}initRefresh(e,t){this.timer&&window.clearInterval(this.timer),this.chunkSize=0===e?2048:e/9/(1e3/t),this.chunkSize<1&&(this.chunkSize=1,t=9e3/e),this.timer=window.setInterval((()=>{this.pause||(this.pause=!0,this.sendChunk(),this.recordHandler&&this.recordHandler(this.vdu.canvas,t),this.pause=!1)}),t)}send(e){this.queue=this.queue.concat(e)}directSend(e){this.queue=[],this.decoder.decodeList(e)}generateThumbnail(e,t){return this.vdu.generateThumbnail(e,t)}sendChunk(){if(0===this.queue.length)return;const e=this.queue.slice(0,this.chunkSize);this.queue=this.queue.slice(this.chunkSize),this.decoder.decodeList(e),this.emptyHandler&&0===this.queue.length&&this.emptyHandler()}setColor(e){return this.color!==e&&(this.color=e,this.vdu.changeColors(e),this.keyboard&&this.keyboard.selectColor(e?"true":"false")),this}setRefresh(e,t){return this.bandwidth!==e&&(void 0===t&&(t=40),this.bandwidth=e,this.initRefresh(e,t),this.keyboard&&this.keyboard.selectSpeed(0===e?"FULL":e.toString())),this}onClick(e){const t=e.target.getBoundingClientRect(),i=this.vdu.getWordAt(e.pageX-t.left-window.scrollX,e.pageY-t.top-window.scrollY);if(""===i)return!0;let s=[];switch(i.toUpperCase()){case"SOMMAIRE":case"SOMM":s=Minitel.keys.Videotex.Sommaire;break;case"ANNULATION":case"ANNUL":s=Minitel.keys.Videotex.Annulation;break;case"RETOUR":s=Minitel.keys.Videotex.Retour;break;case"GUIDE":s=Minitel.keys.Videotex.Guide;break;case"CORRECTION":case"CORR":s=Minitel.keys.Videotex.Correction;break;case"SUITE":s=Minitel.keys.Videotex.Suite;break;case"ENVOI":s=Minitel.keys.Videotex.Envoi;break;case"REPETITION":case"REPET":s=Minitel.keys.Videotex.Repetition;break;default:range(i.length).forEach((e=>{s.push(i.charCodeAt(e))})),s=s.concat(Minitel.keys.Videotex.Envoi)}return this.keyboard&&this.keyboard.keypress(s),!1}};
"use strict";var Minitel=Minitel||{};Minitel.startEmulators=function(){const t=[];return document.querySelectorAll("x-minitel").forEach((e=>t.push(new Minitel.Emulator(e)))),t};
